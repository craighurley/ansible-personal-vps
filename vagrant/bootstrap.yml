---
- hosts: all
  sudo: yes
  gather_facts: yes
  vars_files:
    - "./vars/private/users.yml"

  roles:
    - users

  tasks:
    - name: add group deployment to sudoers
      lineinfile:
        "dest=/etc/sudoers.d/10_deployment
        regexp='^deployment ALL'
        line='%deployment ALL=(ALL) NOPASSWD: ALL'
        state=present
        create=yes
        owner=0 group=0 mode=0640"
      tags:
        - bootstrap

    - name: disallow root ssh access
      lineinfile:
        dest=/etc/ssh/sshd_config
        regexp="^PermitRootLogin"
        line="PermitRootLogin no"
        state=present
      notify:
        - restart ssh
      tags:
        - bootstrap

    - name: disallow ssh password authentication
      lineinfile:
        dest=/etc/ssh/sshd_config
        regexp="^PasswordAuthentication"
        line="PasswordAuthentication no"
        state=present
      notify:
        - restart ssh
      tags:
        - bootstrap

    - name: disallow dns lookups from ssh
      lineinfile:
        dest=/etc/ssh/sshd_config
        regexp="^UseDNS"
        line="UseDNS no"
        state=present
      notify:
        - restart ssh
      tags:
        - bootstrap

    - name: allow ssh access to only those users in the group sshusers
      lineinfile:
        dest=/etc/ssh/sshd_config
        regexp="^AllowGroups"
        line="AllowGroups sshusers"
        state=present
      notify:
        - restart ssh
      tags:
        - bootstrap

  handlers:
    - name: restart ssh
      service: name=sshd enabled=yes state=restarted
